<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="Spring-based application's Reports!">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="/sp/resources/css/normalize.min.css">
        <link rel="stylesheet" href="/sp/resources/css/main.css">  
        <link rel="stylesheet" href="/sp/resources/css/search.css">
        <link rel="stylesheet" href="/sp/resources/css/modal.css">
        <link rel="stylesheet" href="/sp/resources/css/pager.css">
        <link rel="stylesheet" href="/sp/resources/css/jquery-ui-1.10.3.custom.min.css">
      
        <link href='http://fonts.googleapis.com/css?family=Roboto+Slab:100&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

        <script src="/sp/resources/js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script>      
        <script src="/sp/resources/js/libs/jquery-1.10.2.js"></script>
        <script src="/sp/resources/js/libs/jquery-ui-1.10.3.custom.min.js"></script>

    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->
        <div class="page-wrap">
        <div class="header-container">
            <div class="wrapper clearfix">

                <a href="/sp/home"><div id="logo"></div></a>
<h1 class="title">Track your activities</h1>   
<div id="nav">
    <ul>
        <li><a href="/sp/home">Home  </a></li>
        <li><a href="/sp/report">Reports!</a>
            <ul>
                <li><a href="/sp/report/add">Add activity</a></li>
                <li><a href="/sp/report/search?new_search">Build report</a>
                    <ul>
                        <li><a href="/sp/report/search?new_search">Search activity</a></li>
                        <li><a href="/sp/report/detail">Activity details</a></li>
                        <li><a href="/sp/registry">Check registry</a></li>
                    </ul>
                </li>
                <li><a href="/sp/report/suggest">Ajax search</a></li>                                
            </ul>
        </li>
        <li><a  href="/sp/contact">Contact</a>
            <ul>
                <li><a href="/sp/instruction">Instruction</a></li>
                <li><a href="/sp/contact">Contacts</a></li>
                <li><a href="/sp/about">About</a></li>
            </ul>
        </li>
    </ul>
</div>

            </div>
        </div>
        <!-- content -->
        <div class="main-container">
            <div class="main wrapper clearfix">

                     <div class="login-wrap">
        <div class="login-stick">
            <ul>
                <li id="login">
                    <a href="#" data-icon="&#128101;"></a>
                </li>
                <li id="language">
                    <a href="#" data-icon="&#127758;"></a>
                </li>
                <li id="checklist">
                    <a href="/sp/checklist" data-icon="&#59197;"></a>
                </li>
            </ul>
        </div>
        <div class="popup" id="popup-login">
            <div class="arrow"></div>
            <ul>
                                    <li><a href="/sp/login?login=true">Anonymous User</a></li>
                    <li><a href="/sp/login?login=true">Login</a></li>
                            </ul>
        </div>                        
        <div class="popup" id="popup-language">
            <div class="arrow"></div>
            <ul>
                                <li><a href="?lang=en">English</a></li>
                <li><a href="?lang=ru">Russian</a></li>
            </ul>
        </div>
    </div>  
 
                <div class="form-container" style="width: 100%">
    <h2>List of activities</h2>
        <table class="table">
        <caption>Reports! records</caption>
        <thead>
            <tr>
                <th>id</th>
                <th>start of activity</th>
                <th>end of activity</th>
                <th>performer</th>
                <th>activity</th>
            </tr>
        </thead>
        <tbody> current page (-1): 0 isEmpty()?: false search ID: 20681337, pageCount: 5368
                        <tr>
                <td>8</td>
                <td>30 Mar 2013</td>
                <td>22 May 2013</td>
                <td>Ben Affleck</td>
                <td>acting</td>
            </tr>
                        <tr>
                <td>9</td>
                <td>30 Jan 2013</td>
                <td>12 Feb 2013</td>
                <td>Ben Affleck</td>
                <td>scripting</td>
            </tr>
                        <tr>
                <td>25</td>
                <td>23 Feb 2013</td>
                <td>16 Mar 2013</td>
                <td>Brad Pitt</td>
                <td>scoring</td>
            </tr>
                        <tr>
                <td>26</td>
                <td>02 Mar 2013</td>
                <td>17 Apr 2013</td>
                <td>Brad Pitt</td>
                <td>promoting</td>
            </tr>
                        <tr>
                <td>27</td>
                <td>12 Jan 2013</td>
                <td>25 Feb 2013</td>
                <td>Denzel Washington</td>
                <td>acting</td>
            </tr>
                        <tr>
                <td>28</td>
                <td>13 Jan 2013</td>
                <td>26 Feb 2013</td>
                <td>Denzel Washington</td>
                <td>acting</td>
            </tr>
                        <tr>
                <td>29</td>
                <td>14 Feb 2013</td>
                <td>27 Apr 2013</td>
                <td>Denzel Washington</td>
                <td>producing</td>
            </tr>
                        <tr>
                <td>30</td>
                <td>15 Mar 2013</td>
                <td>28 May 2013</td>
                <td>Denzel Washington</td>
                <td>promoting</td>
            </tr>
                        <tr>
                <td>31</td>
                <td>16 Apr 2013</td>
                <td>29 Jun 2013</td>
                <td>Zooye Dechannel</td>
                <td>acting</td>
            </tr>
                        <tr>
                <td>32</td>
                <td>17 May 2013</td>
                <td>30 Jun 2013</td>
                <td>Zooye Dechannel</td>
                <td>singing</td>
            </tr>
                        <div class="button-block clearfix hidden">
                <button class="action" onclick="modalAction(this);">Get URI</button>
                <button class="action update" onclick="modalUpdate(this);">Update</button>          
                <button class="action delete" onclick="modalDelete(this);">Delete</button>
            </div>            
        </tbody>
    </table>
        
                        
<div class="pagination clearfix">  
    <ul class="clearfix">
                    
                                    <li><a href="http://localhost:8088/sp/report/search?p=prev&search_id=$search" class="disabled">«</a></li>            
                                                    <li><a href="http://localhost:8088/sp/report/search?p=1&search_id=20681337" class="current active">1</a></li>
                            <li><a href="http://localhost:8088/sp/report/search?p=2&search_id=20681337" class=" active">2</a></li>
                            <li><a href="http://localhost:8088/sp/report/search?p=3&search_id=20681337" class=" active">3</a></li>
                            <li><a href="http://localhost:8088/sp/report/search?p=4&search_id=20681337" class=" active">4</a></li>
                            <li><a href="http://localhost:8088/sp/report/search?p=5&search_id=20681337" class=" active">5</a></li>
                        <li class="spacer">…</li>            <li><a href="http://localhost:8088/sp/report/search?p=5367&search_id=20681337">5367</a></li>   
                        <li><a href="http://localhost:8088/sp/report/search?p=next&search_id=20681337" >»</a></li>
            </ul>
</div>
                
    <button class="action add" onclick="modalAdd(this);">add new</button>    
    <button class="action" onclick="addToChecklist()">Add to Watchlist</button>

</div>


<script type="text/javascript">

    /*
     * Constants
     */
    var searchId = 20681337;
    
    /*
     * URLs  
     */
    var addToChecklistUrl = "/sp/report/ajax/watch";
    var addReportUrl = "/sp/report/ajax/add";  
    var updateReportUrl = "/sp/report/ajax/update";
    var deleteReportUrl = "/sp/report/ajax/remove";
    var getReportUrl = "/sp/report/ajax";
    var deleteFromChecklistUrl = "/sp/checklist/remove/";
    var getReportUriUrl = "/sp/report/ajax/uri";

    /*
     * Messages
     */
    var SELECT_ONE_MSG = "Select at least one element. <br />Just click on it";
    var ADDED_TO_CHECKLIST_MSG = "Selected elements has been <br />added to your checklist";
    var NOTADDED_TO_CHECKLIST_MSG = "#springessage('checklist.notadded')";     
    var ADDED_MSG = "Report has been successfully added<br />to the database";
    var NOTADDED_MSG = "Report hasn't been added.<br />Please, try later";
    var UPDATED_MSG = "Report has been successfully updated<br />in the database";
    var NOTUPDATE_MSG = "Report cannot be updated<br />in the database";
    var DELETED_MSG = "Selected element has been <br />removed from the database";
    var NOTDELETED_MSG = "Cannot remove selected element<br />cause it doesn't exist.<br /> Please, refresh the page";
    var URI_GOTTEN_MSG = "/spgeturi.gotten";

    /*
     * Modal window HTML templates
     */
    var modalAddHtml = '<h2>Reports! add form</h2> \
<p class="error error-block">    </p> \
<form name="report-add"> \
    <div class="form-line clearfix"> \
        <label for="startDate">Start date:</label> \
        <input id="startDate" name="startDate" value="" type="text" placeholder="Input a start date" autocomplete="off"> \
        <label for="startDate" class="error">    </label> \
    </div> \
    <div class="form-line clearfix"> \
        <label for="endDate">End date:</label> \
        <input id="endDate" name="endDate" value="" type="text" placeholder="Input an end date" autocomplete="off"> \
        <label for="endDate" class="error">    </label> \
    </div> \
    <div class="form-line clearfix"> \
        <label for="performer">Performer:</label> \
        <input id="performer" name="performer" value="" type="text" placeholder="Input a performer"> \
        <label for="performer" class="error">    </label> \
    </div>  \
 \
    <div class="form-line clearfix"> \
        <label for="activity">Activity:</label> \
        <input id="activity" name="activity" value="" type="text" placeholder="Input an activity">      \
        <label for="activity" class="error">    </label> \
    </div> \
    <div class="clearfix"> \
        <div class="button-block-modal"> \
            <button id="add-btn" class="action" name="report-submit" type="submit">Add</button> \
            <button id="close-btn" class="action delete">Close</button> \
        </div> \
    </div> \
</form>        \
';
    var modalUpdateHtml = '<div> \
<h2>Reports! update form</h2> \
<h2>Activity №<span></span></h2> \
 \
<p class="error error-block">    </p> \
<form name="report-update"> \
    <div class="form-line clearfix"> \
        <label for="startDate">Start date:</label> \
        <input id="startDate" name="startDate" value="" type="text" placeholder="Input a start date" autocomplete="off"> \
        <label for="startDate" class="error">    </label> \
    </div> \
    <div class="form-line clearfix"> \
        <label for="endDate">End date:</label> \
        <input id="endDate" name="endDate" value="" type="text" placeholder="Input an end date" autocomplete="off"> \
        <label for="endDate" class="error">    </label> \
    </div> \
    <div class="form-line clearfix"> \
        <label for="performer">Performer:</label> \
        <input id="performer" name="performer" value="" type="text" placeholder="Input a performer"> \
        <label for="performer" class="error">    </label> \
    </div>  \
 \
    <div class="form-line clearfix"> \
        <label for="activity">Activity:</label> \
        <input id="activity" name="activity" value="" type="text" placeholder="Input an activity">      \
        <label for="activity" class="error">    </label> \
    </div> \
    <div class="clearfix"> \
        <div class="button-block-modal"> \
            <button id="update-btn" class="action" name="report-submit" type="submit">Update</button> \
            <button id="close-btn" class="action delete">Close</button> \
        </div> \
    </div> \
</form>        \
</div> \
';
    var modalDeleteHtml = '<div> \
<h2>Remove activity</h2> \
<h2>Activity №<span></span></h2> \
<dl class="dl-horizontal"> \
    <dt>id</dt> \
    <dd id="id"></dd> \
</dl> \
<dl class="dl-horizontal"> \
    <dt>start of activity</dt> \
    <dd id="startDate"></dd> \
</dl>  \
<dl class="dl-horizontal"> \
    <dt>end of activity</dt> \
    <dd id="endDate"></dd> \
</dl> \
<dl class="dl-horizontal"> \
    <dt>performer</dt> \
    <dd id="performer"></dd> \
</dl> \
<dl class="dl-horizontal"> \
    <dt>activity</dt> \
    <dd id="activity"></dd> \
</dl> \
<div class="clearfix"> \
    <span class="modal-span">Are you sure to delete activity?</span> \
    <div class="button-block-modal"> \
        <button id="confirm-btn" class="action">Yes</button> \
        <button id="close-btn" class="action delete">No</button> \
    </div> \
</div> \
</div> \
'; 
    var modalActionHtml = '<div> \
<h2>Activity №<span></span></h2> \
<dl class="dl-horizontal"> \
    <dt>id</dt> \
    <dd id="id"></dd> \
</dl> \
<dl class="dl-horizontal"> \
    <dt>start of activity</dt> \
    <dd id="startDate"></dd> \
</dl> \
<dl class="dl-horizontal"> \
    <dt>end of activity</dt> \
    <dd id="endDate"></dd> \
</dl> \
<dl class="dl-horizontal"> \
    <dt>performer</dt> \
    <dd id="performer"></dd> \
</dl> \
<dl class="dl-horizontal"> \
    <dt>activity</dt> \
    <dd id="activity"></dd> \
</dl> \
<input type="text" value="" name="uri" style="width:320px;"><br /> \
<div class="modal-block"> \
    <div class="button-block-modal"> \
        <button id="close-btn" class="action delete">Close</button> \
    </div> \
</div> \
</div> \
';

    /*
     * Utilizes: 
     *    1. modal - modal.js
     *    2. validation rules - validation.js
     */
      
 
    /*
     * Pop-up hint 
     */
    $(document).ready(function() {
       $(document.createElement("div"))
                .attr("id", "confirm")
                .appendTo($("body"))
                .hide();      
    });

    /*
     * Add to checklist handler 
     */
    function addToChecklist() {
        var indexes = [];
        $('tr.selected').each( function(index, value) {            
            try {
                indexes.push(parseInt($(value).find('td:first-child').html()));
            } catch (error){
                console.log("Error while parsing ID for a elemend beign selected");
            }
        });    
        if (indexes.length > 0) {
            var indexesData = { "indexes" : indexes };
            $.ajax( addToChecklistUrl, 
                   {method: "POST",
                    async: true,
                    cache: false,
                    data: indexesData,
                    complete: onWatchComplete,
                    dataType: 'text' });
        } else {
            $("#confirm").finish().html(SELECT_ONE_MSG)  
                .fadeIn(600)
                .delay(3000)
                .fadeOut(1200);
        }
    };

    /*
     * Callback for addToChecklist Ajax request
     */
    function onWatchComplete(xhr, status) {
        if (status === "success") {
            $("#confirm").finish().html(ADDED_TO_CHECKLIST_MSG);
            $(".selected").removeClass("selected").addClass("selected-added");
        } else {
            $("#confirm").finish().html(NOTADDED_TO_CHECKLIST_MSG);
            console.log("Cannot fulfil request to the server: " + status);
        }       
        $("#confirm").fadeIn(600)
                     .delay(3000)
                     .fadeOut(1200);
    };

    /*
     * Adding new report handler
     */
    function modalAdd(addButton) {
        var url = addReportUrl;  
        var html = modalAddHtml;       
        modal.open({ content: html });
        $("#close-btn").click(function() {
            $("#close").click();
        });
        $("form[name='report-add']").validate({
        //  debug: true,
            rules: {
               startDate: {
                    required: true,
                    reportdate: true
                },
                endDate: {
                    reportdate: true
                },
                performer: {
                    required: true,
                    rangelength: [1, 255],
                    regexp: performer_regexp
                },
                activity: {
                    required: true,
                    rangelength: [1, 255],
                    regexp: activity_regexp
                }
            }
        });
        $("#add-btn").click(function(e) {
            e.preventDefault();
        //  if ($("form[name='report-add']").valid()) {
            var  $confirm = $("#confirm");
            var serial_report = $(addButton).parent("form[name='report-add']").serialize();
            serialReport = $('form[name="report-add"]').serialize();
            $.post(url,
                   serialReport,
                   function(data, status, jxhr) {
                       if (data.status === 'success') {
                           $confirm.html(ADDED_MSG);
                        } else {
                           $confirm.html(NOTADDED_MSG);
                        }                    
                        $confirm.finish().fadeIn(600).delay(3000).fadeOut(1200);
                    },
                    'text'
            );   
            $("#close-btn").click();         
            return false;
        //  } //#if
        });
    } 

    /*
     * Updating report handler
     */
    function modalUpdate(updateButton) {
        var url = getReportUrl;   
        var urlUpdate = updateReportUrl;         
        var html = $(modalUpdateHtml);        
        var idVal = $(updateButton).parent(".button-block").data("id").trim();
        $.get(url, 
              {id: idVal},
              function(report) {
                  // populate form with returned report fields
                  html.find("#startDate").attr("value", (new Date(report.startDate)).toString());
                  html.find("#endDate").attr("value", (new Date(report.endDate)).toString());
                  html.find("#performer").attr("value", report.performer);
                  html.find("#activity").attr("value", report.activity);
                  html.find("#activity").val(report.activity);
                  html.find("span").text(report.id);
                  html = html.get(0).outerHTML;
                  
                  modal.open({content: html});
                  $("#close-btn").click(function() {
                      $("#close").click();
                  });
                  
                  // validate the form
                  $("form[name='report-update']").validate({
                  //  debug: true,
                      rules: {
                        startDate: {
                            required: true,
                            reportdate: true
                        },
                        endDate: {
                            reportdate: true
                        },
                        performer: {
                            required: true,
                            rangelength: [1, 255],
                            regexp: performer_regexp
                        },
                        activity: {
                            required: true,
                            rangelength: [1, 255],
                            regexp: activity_regexp
                        }
                      }
                  });

                $("#update-btn").click(function(e) {
                    // before ajax call cause defaul action will be fired up
                    e.preventDefault();
                    // if($("form[name='report-update']").valid()) {      
                        var idVal = $(updateButton).parent(".button-block").data("id").trim();                
                        var serialReport = $("form[name='report-update']").serialize();
                        serialReport = serialReport + "&id=" + encodeURI(idVal);
                        $.ajax(urlUpdate, {
                               method: "POST",
                               async: true,
                               cache: false,
                               data: serialReport,
                               success: function(result) {
                                 if (result.status === 'success') {
                                    $("#confirm").finish().html(UPDATED_MSG);
                                    $("#confirm").fadeIn(600)
                                                 .delay(3000)
                                                 .fadeOut(1200);                      
                                 } else {

                                 }
                               },
                               error: function() {
                                 $("#confirm").finish().html(NOTUPDATE_MSG);                                                                 
                                 $("#confirm").fadeIn(600)
                                              .delay(3000)
                                              .fadeOut(1200);                      
                                 }, 
                               dataType: 'json'
                        });
                        $("#close-btn").click();
                    // } //#if
                    return false;
                });
            },
            'json' 
        );            
    }

    /*
     * Delete report handler
     */
    function modalDelete(deleteButton) {
        var html = modalDeleteHtml; 
        var url = getReportUrl;  
        var idVal = $(deleteButton).parent(".button-block").data("id").trim();
           $.get(url, 
                 {id: idVal},
                 function(report) {
                   html = $(html).find("#id").text(report.id).end()
                                 .find("#startDate").text((new Date(report.startDate)).toString()).end()
                                 .find("#endDate").text((new Date(report.endDate)).toString()).end()
                                 .find("#performer").text(report.performer).end()
                                 .find("#activity").text(report.activity).end();
                  html.find("span").text(report.id);                  
                  html = html.get(0).outerHTML;
                  modal.open({ content: html });
                  $("#close-btn").click(function() {
                      $("#close").click();
                  });
                  $("#confirm-btn").click(function() {   
                      var url = deleteReportUrl;
                      $.post(url, 
                             {id: idVal},
                             function(data) {
                                 if (data === 'success') {                        
                                     $("#close").click(); 
                                     // remove table row from DOM                        
                                     $(".button-block").addClass(".hidden").appendTo(".table");
                                     $(".active-row").remove();
                                     // remove from checklist? and pager? URL: '/report/ajax/pager/remove'
                                     $("#confirm").finish().html(DELETED_MSG); 
                                 } else {
                                     $("#close").click(); 
                                     $("#confirm").finish().html(NOTDELETED_MSG);                         
                                 }
                                 $("#confirm").fadeIn(600)
                                              .delay(3000)
                                              .fadeOut(1200);
                             },
                             'text'
                      );
                  });
             },
             'json'
           );         
  //      var cleanChecklistUrl = deleteFromChecklistUrl + idVal;
  //      $.post(cleanChecklistUrl, 
  //         {},
  //         function(data) {
  //            if (data !== "success") {
  //               console.log("Cannot remove report from checklist.");
  //             }
  //         },
  //         'text'
  //      );
    };

    /*
     * Report details handler
     */
    function modalAction(actionButton) {
        var idVal = $(actionButton).parent(".button-block").data("id").trim();        
        var html = $(modalActionHtml);
        var error = false;
        var url = getReportUrl; 
        $.get(url, 
              {id: idVal},
              function(report) {                 
                 html.find("#id").text(report.id).end()
                     .find("#startDate").text((new Date(report.startDate)).toString()).end()
                     .find("#endDate").text((new Date(report.endDate)).toString()).end()
                     .find("#performer").text(report.performer).end()
                     .find("#activity").text(report.activity).end();
                 html.find("span").text(report.id);                
              },
              'json'
        );     
        $.ajax(getReportUriUrl, {
            method: "GET",
            async: false,
            cache: false,
            data: "id=" + idVal,
            dataType: 'text',
            success: function(data) {      
                html.find("input[type='text']").val(data);                
            },
            error: function() {
                error = true;
            },
            complete: function() {                
            }
        });
        if (error) {
            $("#confirm").finish().html(URI_GOTTEN_MSG);                         
            $("#confirm").fadeIn(600)
                         .delay(3000)
                         .fadeOut(1200);
        } else {
            modal.open({ content: html });
            $("#close-btn").click(function() {
                $("#close").click();
            }); 
        }
    }; 

</script>    


                    <div class="sticky">
        <a href="#"><i class="icon-briefcase"></i>Get a hint!</a>
    </div>

            </div> <!-- #main -->
        </div> <!-- #main-container -->
        </div> <!-- #page_wrap -->
        <div class="footer-container">
            <div class="wrapper clearfix">

                <a href="/sp/home"><div id="logo_small"></div></a>
<a href="/sp/contact"><h3 style="float:left; text-decoration: none; color: #dddddd;">Paul Kulitski 2013</h3></a>
<h3 id="facebook" class="image-replacement facebook-dark"><a href="https://www.facebook.com/pavel.kulicki"><span>Facebook Profile</span></a></h3>
<h3 id="google" class="image-replacement google-dark"><a href="mailto:p.kulitski@gmail.com"><span>Google Mail</span></a></h3>
<h3 id="twitter" class="image-replacement twitter-dark"><a href="https://twitter.com/PaulKulitski"><span>Twitter Profile</span></a></h3>

            </div>
        </div>

        <script src="/sp/resources/js/libs/jquery.validate.js"></script>        
        <script src="/sp/resources/js/validation.js"></script>
        <script type="text/javascript" src="/sp/resources/js/search.js"></script>
        <script type="text/javascript" src="/sp/resources/js/modal.js"></script>
        <script src="/sp/resources/js/main.js"></script>
        
        
        
        <script type="text/javascript" src="/sp/resources/js/localization/messages_en.js"></script>

            
            <script type="text/javascript">
        $.datepicker.setDefaults(
            {'dateFormat': 'dd M yy'}
        );
    </script>
    

        <script type="text/javascript">
        </script>
        
    </body>
</html>
